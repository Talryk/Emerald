{"type":"group","name":"EmeraldBash","enabled":true,"items":[{"type":"function","name":"initTargetList","enabled":true,"code":"let emerald = client.emerald;\n\nemerald.bash.targets = {\n  //Astral beasts\n  'a ravenous fesix': {alias:'fesix', priority: 0},\n  'a robed obesefessor': {alias:'obesefessor', priority: 0},\n  'an emaciated virgin': {alias:'virgin', priority: 0},\n  'a gargantuan red scorpion': {alias:'scorpion', priority: 0},\n  'a floating urn': {alias:'urn', priority: 0},\n  'a hulking three-horned bull': {alias:'bull',priority: 0},\n  'a two-headed eagle': {alias:'eagle', priority: 0},\n  'a bloated parasite': {alias:'parasite',priority: 0},\n  'a two-headed abhorrence': {alias:'abhorrence', priority: 0},\n  'a sadistic mitran': {alias:'mitran', priority: 0},\n  'a stainless steel goat': {alias:'goat', priority: 0},\n  'a monstrous lobstrosity': {alias:'lobstrosity', priority: 0},\n\n  //Domoth beasts\n  'a king of justice': {alias:'justice',priority:0},\n  'a lost soul of death': {alias:'death', priority: 0},\n  'a radiant defender of life': {alias:'life', priority:0},\n\n  //Elemental beasts\n  //Air\n  'an aerial stalker': {alias:'stalker', priority: 0},\n  'a curlicued stormeater': {alias:'stormeater', priority: 0},\n  'a cloud carrion': {alias:'carrion', priority: 0},\n\n  //Water\n  'a serpentine starsucker': {alias:'starsucker',priority: 0},\n  'a dream leech': {alias:'leech', priority: 0},\n\n  //Fire\n  'a flame hog': {alias:'hog', priority: 0},\n  'a cinder crawler': {alias:'crawler', priority: 0},\n  'a fire mantis': {alias:'mantis', priority: 0},\n\n  //Earth\n  'a morbidly tainted grub': {alias:'grub', priority: 0},\n  'a huge lindwyrm': {alias:'lindwyrm', priority: 0},\n  'a decaying gargoyle': {alias:'gargoyle', priority: 0},\n  'a slavering stoneghast': {alias:'stoneghast', priority: 1},\n\n  //Etherwilde\n\n  //Etherglom\n\n  //Mount Dio\n  'a snow white skara': {alias:'skara', priority: 0},\n  'an ice blue skara': {alias:'skara', priority: 0},\n  'a crimson-scaled skara': {alias:'skara', priority: 1},\n  'a beastial garul': {alias:'garul', priority: 2},\n  'a massive ice worm': {alias:'worm', priority: 1},\n\n  //Undervault\n  'a hard-shelled, many-legged cave-fisher': {alias:'fisher',priority: 1},\n  'an algae-like phycomid': {alias:'phycomid', priority: 0}\n}\n"},{"type":"function","name":"onGMCP","enabled":true,"code":"if (args.gmcp_method == \"Char.Items.List\") {\n  let emerald = client.emerald\n  emerald.debugmsg(JSON.stringify(args));\n  if (emerald.bash.active) {\n    args.gmcp_args.items.forEach(item => {\n      //If target is on the list\n      if (Object.keys(emerald.bash.targets).includes(item.name)) {\n        emerald.debugmsg('scanning target list')\n        let targetFound = false; //scan current queue for this room item\n        emerald.bash.queue.forEach(t => {\n          if (t.id == item.id) targetFound = true; emerald.debugmsg('target identified');\n        });\n        if (!targetFound) {\n          emerald.debugmsg(`target ${item.id} not queued`);\n          //Push into queue at defined priority.\n          emerald.bash.queue.push({\n            'id': item.id, //target is attacked by id\n            'alias': emerald.bash.targets[item.name].alias, //to watch for kills\n            'priority': emerald.bash.targets[item.name].priority //aggro priority\n          });\n          emerald.debugmsg(JSON.stringify(emerald.bash.queue));\n          if (!get_variable('emerald_bash_target')) emerald.bash.retarget();\n          //emerald.bash.try();\n        }\n      }\n    });\n    emerald.bash.try();\n  }\n}\n\nif (args.gmcp_method == \"Char.Items.Add\") {\n  let emerald = client.emerald;\n  emerald.debugmsg(JSON.stringify(args));\n  if (emerald.bash.active) {\n    let item = args.gmcp_args.item\n    if (emerald.bash.targets[item.name] && !emerald.bash.queue[item.id]) {\n      emerald.bash.queue.push({\n        'id': item.id,\n        'alias': emerald.bash.targets[item.name].alias,\n        'priority': emerald.bash.targets[item.name].priority\n      });\n    }\n  }\n}\n\nif (args.gmcp_method == \"Char.Items.Remove\" && args.gmcp_args.location == \"room\") {\n  let emerald = client.emerald;\n  emerald.debugmsg(JSON.stringify(args));\n  if (emerald.bash.active && emerald.bash.queue.length > 0) {\n    let item = args.gmcp_args.item;\n    let itemQueued, itemIndex;\n    for (let i in emerald.bash.queue) {\n      if (i.id == item.id) {\n        itemQueued = true;\n        itemIndex = i;\n      }\n    }\n    if (itemQueued && itemIndex) {\n      emerald.bash.queue.length > 1\n        ? emerald.bash.queue[itemIndex] = emerald.bash.queue.pop()\n        : emerald.bash.queue.pop();\n    }\n  }\n}\n"},{"type":"function","name":"onInstall","enabled":true,"code":"let emerald = client.emerald;\nlet bash = emerald.bash = {\n  name: 'EmeraldBash',\n  version: '0.0.1.20240528',\n};\n\nbash.reset = () => {\n  bash.active = false;\n  bash.mode = 'none';\n  bash.queue = [];\n  bash.noTargetCount = 0;\n  bash.targetname = '';\n  bash.targetid = '';\n}\n\n\nbash.try = () => {\n  if (bash.active && !emerald.flags.get('tryingBash')) {\n    if (bash.queue.length > 0){\n      let cmd = '';\n      emerald.flags.get('targetshielded') ? cmd = get_variable('emerald_bash_raze') : cmd = get_variable('emerald_bash_attack');\n      emerald.debugmsg(`attempting bash command: ${cmd}`);\n      if (emerald.bals.onbal) {\n        emerald.flags.set('tryingBash',true,1500);\n        if (get_variable('emerald_bash_beastatk')=='true' && emerald.bals.B) emerald.queue.add(`beast order attack ${bash.targetname + bash.targetid}`,true);\n        emerald.queue.add(cmd.replace('@',bash.targetname).replace('#',bash.targetid));\n      } \n    } else {\n      emerald.emnote('No targets found.','Bash');\n      bash.reset();\n      emerald.prompt.onPrompt();\n    }    \n  }\n}\nbash.retarget = () => {\n  if(bash.queue.length > 0) {\n    //start scanning queue at 0\n    let targetIndex = 0\n    if(bash.queue.length > 1) {\n      var currentPriority = bash.queue[targetIndex].priority;\n      for (let t in bash.queue) {\n        //If any target in the queue has a higher priority, that resets the bar.\n        if (bash.queue[t].priority > currentPriority) {\n          targetIndex = t;\n          currentPriority = bash.queue[t].priority;\n        }\n      } //next t\n    }\n    bash.targetid = bash.queue[targetIndex].id;\n    bash.targetalias = bash.queue[targetIndex].alias;\n    bash.try();\n  }\n}\n\nbash.remove = (id) => {\n  emerald.debugmsg(`Removing target ${id}`);\n  for (let t in bash.queue) {\n    if (bash.queue[t].id == id) {\n      if (t == bash.queue.length-1) {\n        bash.queue.pop();\n      } else {\n        bash.queue[t] = bash.queue.pop();\n      }\n    }\n  }\n  if (bash.queue.length > 0) {\n    bash.retarget();\n  } else {\n    if (bash.mode == 'room') emerald.emnote('Room cleared.','Bash');\n    bash.reset();\n  }\n  emerald.debugmsg(`Remaining queue: ${JSON.stringify(bash.queue)}`);\n}\n\nbash.reset();\nemerald.plugins['bash'] = true;\nrun_function('initTargetList','','EmeraldBash');\nclient.emerald.emnote(`${bash.name} v${bash.version} initialised.`);"},{"type":"function","name":"onUninstall","enabled":true,"code":"client.emerald.bash = {};"},{"type":"trigger","name":"emerald_bash_essencedrop","enabled":true,"actions":[{"type":"script","enabled":true,"script":"client.emerald.queue.qf.push('g essence');"}],"text":"^(?:As .*? perishes\\, several droplets of water coalesce into a bit of light essence\\.|.*? shrieks as it perishes\\, its dying cry forming into a bit of cloud essence\\.|A bit of fiery essence pours out of .*?\\'s mouth with its dying breath\\.|A bit of dark essence tumbles out of .*?\\.|A bit of silvery essence tumbles out of .*?\\.|A bit of shadowy essence tumbles out of .*?\\.)$","matching":"regexp","whole_words":true,"case_sensitive":false},{"type":"trigger","name":"emerald_bash_golddrop","enabled":true,"actions":[{"type":"command","enabled":true,"command":"qf g gold","prefix_suffix":false}],"text":"^You have slain (?:.*?)\\. .*? sovereigns .*? corpse\\.$","matching":"regexp","whole_words":true,"case_sensitive":true},{"type":"trigger","name":"emerald_bash_shieldup","enabled":true,"actions":[{"type":"script","enabled":true,"script":"if (args[1].includes(get_variable('target'))) {\n  client.emerald.emnote('TARGET SHIELDED!!');\n  client.emerald.flags.set('targetshielded',true,3000);\n}"}],"text":"^(?:A dizzying beam of energy strikes you as your attack rebounds off |Eyes glowing red\\, )?(.*?)(?: mutters and traces a cobalt blue pentagram in the air that remains hovering before [Hh](?:im|er)|\\'s shield| bellows and a shield of protection flickers into view around [Hh](?:is|er) form)\\.$","matching":"regexp","whole_words":true,"case_sensitive":true},{"type":"trigger","name":"emerald_bash_shielddown","enabled":true,"actions":[{"type":"script","enabled":true,"script":"if (args[1].includes(get_variable('target'))) {\n  client.emerald.flags.clear('targetshielded');\n  client.emerald.emnote('Target shield removed!!')\n}"}],"text":"^(?:You raze |.+? \\'s attack passes through the shield of)?(.*?)(?:\\, the protective sphere dissolving into thin air|\\'s action causes the nearly invisible magical shield around him to fade away| magical shield with a clawed fist)\\.$","matching":"regexp","whole_words":true,"case_sensitive":true},{"type":"alias","name":"emerald_bash_configatk","enabled":true,"actions":[{"type":"script","enabled":true,"script":"switch (args[1]) {\n  case 'attack':\n    set_variable('emerald_bash_attack',args[2]);\n    client.emerald.emnote(`Bashing attack set to ${args[2]}.`);\n    break;\n  case 'raze':\n    set_variable('emerald_bash_raze',args[2]);\n    client.emerald.emnote(args[2].toLowerCase() == 'none' || args[2].toLowerCase() == 'wait' ? 'Waiting for shields to drop while bashing.' : `Bashing raze attack set to ${args[2]}.`);\n    break;\n  case 'beast':\n    set_variable('emerald_bash_beastatk',args[2]=='on');\n    client.emerald.emnote(`${args[2]=='on'?'U':'Not u'}sing beast attacks.`,'Bash');\n}"}],"text":"^cfg bash (attack|raze) (.+?)$","matching":"regexp","whole_words":true,"case_sensitive":true,"prefix_suffix":true},{"type":"alias","name":"emerald_bash_start","enabled":true,"actions":[{"type":"script","enabled":true,"script":"let bash = client.emerald.bash\nswitch (args[1]) {\n  case 'a':\n    //bash area start\n    break;\n  case 'r':\n    bash.active = true;\n    bash.mode = 'room';\n    bash.noTargetCount = 0;\n    send_GMCP('Char.Items.Room','');\n    client.emerald.emnote('Bashing all room targets.','Bash');\n    client.emerald.flags.set('gettingGmcp',true,100,'client.emerald.prompt.onPrompt()');\n    break;\n  case 's':\n    bash.active = false;\n    bash.mode = 'none';\n    bash.queue = [];\n    client.emerald.emnote('Bashing queue cleared.','Bash');\n}"}],"text":"^b(a|r|s)$","matching":"regexp","whole_words":true,"case_sensitive":true,"prefix_suffix":true},{"type":"trigger","name":"emerald_bash_notarget","enabled":true,"actions":[{"type":"script","enabled":true,"script":"let emerald = client.emerald;\n\nemerald.bash.noTargetCount += 1;\nif (emerald.bash.noTargetCount > 3) {\n  emerald.bash.remove(get_variable('emerald_bash_target'));\n  emerald.bash.retarget();\n}"}],"text":"^(?:You cannot see that being here\\.|Ahh\\, I am truly sorry\\, but I do not see anyone by that name here\\.|I do not recognize anything called that here\\.|You detect nothing here by that name\\.|Nothing can be seen here by that name\\.)$","matching":"regexp","whole_words":true,"case_sensitive":true},{"type":"trigger","name":"","enabled":true,"actions":[{"type":"script","enabled":true,"script":"let emerald = client.emerald\nlet tar = get_variable('emerald_bash_target')\nlet taralias = get_variable('emerald_bash_targetalias');\nif (emerald.bash.active && args[1].includes(taralias)) {\n  emerald.debugmsg(`Removing target ${tar}`)\n  emerald.bash.remove(tar);\n}"}],"text":"^You have slain (.+?)\\.$","matching":"regexp","whole_words":true,"case_sensitive":true}],"description":"Hunting Triggers"}